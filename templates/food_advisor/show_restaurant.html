{% extends 'base.html' %}
{% load static %}

{% block title %}
    Food Advisor - {{ restaurant.name }}
{% endblock title %}

{% block content %}
<div class="container my-5">
    {% if restaurant %}
        <h1 class="display-4 text-center mb-3">{{ restaurant.name }}</h1>

        {% if user.is_authenticated and user == restaurant.manager.user %}
        <p class="display-8 text-center mb-3" style="color:#a32410">You are this restaurant's manager.</h3>
        {% endif %}

        <div id="star-block" class="text-center mb-3">
            {% with ''|center:restaurant.getIntegerStars as range %}
            {% for _ in range %}
                <img src="{% static 'images/star.png' %}" class="img-fluid" style="height: 25px;">
            {% endfor %}
            {% endwith %}

            <p class="lead">Average Star Rating: {{ restaurant.starRating|floatformat:2 }}</p>
        </div>

        <div id="image-block" class="text-center mb-3">
            {% if restaurant.image %}
                <img src="{{ restaurant.image.url }}" class="img-fluid rounded" alt="{{ restaurant.name }}">
            {% else %}
                <img src="{% static 'images/1.jpg' %}" class="img-fluid rounded" alt="{{ restaurant.name }}" style="width: 800px; height: auto;">
            {% endif %}

        </div>

        <div id="reviews-link-block" class="text-center mb-3">
            <h3><a href="{% url 'food_advisor:show_restaurant_reviews' restaurant.id %}" class="btn btn-primary">View Reviews ({{ restaurant.totalReviews }})</a></h3>
        </div>

        <div id="address-block" class="mb-3">
            <h3>Address</h3>
            <p>{{ restaurant.address }}</p>
        </div>
        <div id="map" style="height: 400px;"></div>

        <div id="hours-block" class="mb-3">
            <h3>Opening Hours</h3>
            <p>{{ restaurant.timeOpens|time:"G:i"}} - {{ restaurant.timeCloses|time:"G:i" }}</p>
        </div>

        <div id="tags-block" class="mb-3">
            <h3>Tags</h3>
            <!-- Assume tags is a list, display as badges -->
            <p>
                {% for tag in restaurant.getTags %}
                    <span class="badge badge-secondary">{{ tag }}</span>
                {% endfor %}
            </p>
        </div>

        <div id="cuisine-type-block" class="mb-3">
            <h3>Cuisine Type</h3>
            {% if restaurant.cuisineTypes %}
                {% for type in restaurant.getCuisines %}
                    <span class="badge badge-secondary">{{ type }}</span>
                {% endfor %}
            {% else %}
                <p>No cuisine types available</p>
            {% endif %}
        </div>

        <div id="menu-block" class="mb-5">
            <h3>Menu</h3>
            {% if dishes %}
                <ul class="list-group">
                    {% for dish in dishes %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ dish.name }}
                            <span class="badge badge-primary badge-pill">Â£{{ dish.price }}</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <div class="alert alert-warning" role="alert">No menu available.</div>
            {% endif %}
        </div>

        {% if user.is_authenticated and user == restaurant.manager.user %}
        <div class="text-center mb-3">
            <a href="{% url 'food_advisor:manage_restaurant' restaurant.id %}" class="btn btn-info">Manage Restaurant Info</a>
        </div>
        {% endif %}

    {% else %}
        <div class="alert alert-danger" role="alert">
            The specified restaurant does not exist.
        </div>
    {% endif %}
</div>

<script>
    function initMap() {
        var geocoder = new google.maps.Geocoder();
        var address = '{{ restaurant.address }}';

        geocoder.geocode({ 'address': address }, function(results, status) {
            if (status === 'OK') {
                var map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 15,
                    center: results[0].geometry.location
                });

                var marker = new google.maps.Marker({
                    map: map,
                    position: results[0].geometry.location,
                    title: '{{ restaurant.name }}'
                });
            } else {
                console.error('Geocode was not successful for the following reason: ' + status);
            }
        });
    }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap" async defer></script>

{% endblock content %}
